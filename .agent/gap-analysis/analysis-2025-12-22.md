# Gap Analysis & Completion Roadmap

This document outlines the current state of the **Usage-Based Metering & Invoicing Pipeline** and identifies the work needed to reach the vision described in the documentation.

## Current State Summary

The project has a solid foundation with NestJS, Kafka, and PostgreSQL. Basic event-time windowing exists, and there is a structure for price books and invoices. However, many core "billing hard problems" are either TODOs or simplified placeholders.

---

## üèóÔ∏è Layer-by-Layer Gaps

### 1. Metering & Aggregation
*   **Status**: ‚úÖ Basic-Completed
*   **Accomplishments**: Robust DB-backed state, `SUM`/`MAX` strategies, and late-arrival redirection.

### 2. Rating Engine
*   **Status**: ‚úÖ Basic-Completed
*   **Accomplishments**: Full support for Tiered and Volume pricing rules with high-precision math and calculation explainability.

### 3. Invoicing
*   **Status**: ‚úÖ Basic-Completed
*   **Accomplishments**: Dynamic regional taxes, customer credit/adjustment system, multi-currency support, and CSV export.

### 4. Corrections & Re-rating
*   **Status**: ÔøΩ Partial / In-Progress
*   **Gaps**:
    *   **Rewind Mechanism**: Needs a dedicated service to consume `late-events` and trigger re-calculation.
    *   **Correction Invoices**: Automated logic for generating delta invoices (credit notes/correction invoices) when data changes post-issue.
    *   **Deterministic Re-calc**: Full workflow for deterministic historical reprocessing.

---

## üöÄ Completion Roadmap

### Phase 1: Rating Engine Logic (Priority: High)
Implement the core pricing math that makes the system useful.
1.  **Tiered Pricing**: Implement discrete price tiers (e.g., first 1k free, next 9k @ $0.01).
2.  **Volume Pricing**: Implement all-units pricing based on total volume.
3.  **Charge Linkage**: Ensure `RatedCharge` correctly references the metric type and aggregation.

### Phase 2: Robust Aggregation (Priority: High)
Ensure no data is lost and different metrics are supported.
1.  **State Persistence**: Store window state in PostgreSQL (or Kafka changelog) to survive restarts.
2.  **Aggregation Strategies**: Add `SUM` and `MAX` aggregation logic.
3.  **Late Event Topic**: Instead of dropping late events, send them to a `late-events` topic for the re-rating service.

### Phase 3: Real Invoicing (Priority: Medium)
Make the invoices professional and accurate.
1.  **Metric Grouping**: Fix the grouping logic in `InvoicesService`.
2.  **Simple Tax Logic**: Add a configurable tax rate service.
3.  **Credit/Adjustment System**: Add a table/service for manual account adjustments.

### Phase 4: Re-rating Workflow (Priority: Medium)
Solve the "hardest" problem.
1.  **Re-rating Service**: Create a service that can consume the `late-events` topic and trigger re-calculations.
2.  **Correction Logic**: Logic to compare a "new" invoice version with an "issued" one and generate a delta charge.

---

## üõ†Ô∏è Immediate Next Steps

I recommend starting with **Phase 1: Rating Engine Logic**, as it is the most critical for the system's "Correctness" goal and has well-defined unit tests in the existing codebase that can be expanded.
