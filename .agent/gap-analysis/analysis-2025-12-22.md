# Gap Analysis & Completion Roadmap

This document outlines the current state of the **Usage-Based Metering & Invoicing Pipeline** and identifies the work needed to reach the vision described in the documentation.

## Current State Summary

The project has a solid foundation with NestJS, Kafka, and PostgreSQL. Basic event-time windowing exists, and there is a structure for price books and invoices. However, many core "billing hard problems" are either TODOs or simplified placeholders.

---

## üèóÔ∏è Layer-by-Layer Gaps

### 1. Metering & Aggregation
*   **Status**: üü† Partial
*   **Gaps**:
    *   **State Persistence**: Windows are in-memory. Restarting the service loses active window state.
    *   **Late Arrivals**: Events arriving after the window closed are currently logged and dropped. No re-rating trigger.
    *   **Aggregation Logic**: Only `COUNT` is implemented. Needs `SUM` (storage), `MAX` (peak usage), and `AVG`.
    *   **Watermarks**: Heuristic is fixed to 1 hour. Needs to be more dynamic or configurable per metric.

### 2. Rating Engine
*   **Status**: üü† Partial
*   **Gaps**:
    *   **Pricing Models**: Tiered and Volume pricing are placeholders. Only Flat/Per-unit works.
    *   **Precision**: `decimal.js` is used via `Money` types, which is good, but the complex math for tiers isn't implemented.
    *   **Explainability**: `calculation_metadata` is minimal. It lacks the full trail from raw events to charge.

### 3. Invoicing
*   **Status**: üü° Basic
*   **Gaps**:
    *   **Charge Grouping**: Charges are grouped by a placeholder `'usage'` string. Needs to group by actual metric type.
    *   **Adjustments**: No support for credits, refunds, or manual overrides.
    *   **Taxes**: Placeholder for tax calculation.
    *   **Artifacts**: No PDF/JSON export for customer delivery.

### 4. Corrections & Re-rating
*   **Status**: üî¥ Not Implemented
*   **Gaps**:
    *   **Rewind Mechanism**: No way to trigger a re-process of historical Kafka events.
    *   **Correction Invoices**: No logic to generate "Correction" or "Credit Note" invoices when usage changes after an invoice was issued.
    *   **Deterministic Re-calc**: Re-rating is a core goal but has no service or workflow implementation yet.

---

## üöÄ Completion Roadmap

### Phase 1: Rating Engine Logic (Priority: High)
Implement the core pricing math that makes the system useful.
1.  **Tiered Pricing**: Implement discrete price tiers (e.g., first 1k free, next 9k @ $0.01).
2.  **Volume Pricing**: Implement all-units pricing based on total volume.
3.  **Charge Linkage**: Ensure `RatedCharge` correctly references the metric type and aggregation.

### Phase 2: Robust Aggregation (Priority: High)
Ensure no data is lost and different metrics are supported.
1.  **State Persistence**: Store window state in PostgreSQL (or Kafka changelog) to survive restarts.
2.  **Aggregation Strategies**: Add `SUM` and `MAX` aggregation logic.
3.  **Late Event Topic**: Instead of dropping late events, send them to a `late-events` topic for the re-rating service.

### Phase 3: Real Invoicing (Priority: Medium)
Make the invoices professional and accurate.
1.  **Metric Grouping**: Fix the grouping logic in `InvoicesService`.
2.  **Simple Tax Logic**: Add a configurable tax rate service.
3.  **Credit/Adjustment System**: Add a table/service for manual account adjustments.

### Phase 4: Re-rating Workflow (Priority: Medium)
Solve the "hardest" problem.
1.  **Re-rating Service**: Create a service that can consume the `late-events` topic and trigger re-calculations.
2.  **Correction Logic**: Logic to compare a "new" invoice version with an "issued" one and generate a delta charge.

---

## üõ†Ô∏è Immediate Next Steps

I recommend starting with **Phase 1: Rating Engine Logic**, as it is the most critical for the system's "Correctness" goal and has well-defined unit tests in the existing codebase that can be expanded.
